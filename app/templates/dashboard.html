{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

<!-- Macro to recursively render subtasks for each task -->
{% macro render_subtasks(task) %}
<div style="margin-left: 20px;">
    <!-- Collapse button to toggle visibility of subtasks -->
    <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
    <span>{{ task.title }} ({{ task.status }})</span>

    <!-- Form to delete a specific task with CSRF token for protection -->
    <form action="{{ url_for('auth.delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Delete</button>
    </form>

    <!-- Link to add a subtask if max depth (3) is not reached -->
    {% if task.get_depth() < 3 %} <a href="{{ url_for('auth.add_subtask', task_id=task.id) }}">Add Subtask</a>
        {% else %}
        <span style="color: gray;">Max depth reached</span>
        {% endif %}

        <!-- Recursively render subtasks if any are present -->
        {% if task.subtasks %}
        <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
            {% for subtask in task.subtasks %}
            {{ render_subtasks(subtask) }}
            {% endfor %}
        </div>
        {% endif %}
</div>
{% endmacro %}

{% block content %}
<h1>Your Task Dashboard</h1>

<!-- Display logged-in user's name with logout link -->
<div>
    <h2>Logged in as {{ current_user.username }} | <a href="{{ url_for('auth.logout') }}">Logout</a></h2>
</div>

<!-- Link to create a new task group -->
<div>
    <h3><a href="{{ url_for('auth.create_task_group') }}">Create New List</a></h3>
</div>

<!-- Loop through each task group to display its tasks -->
{% for group in task_groups %}
<div class="task-group" ondragover="allowDrop(event)" ondrop="drop(event, {{ group.id }})"
    style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
    <h2>{{ group.title }}</h2>

    <!-- Link to add a new task to the current group -->
    <a href="{{ url_for('auth.add_task', group_id=group.id) }}">Add New Task</a>

    <!-- Form to delete the entire task group, with CSRF token for security -->
    <form action="{{ url_for('auth.delete_task_group', group_id=group.id) }}" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" onclick="return confirm('Are you sure you want to delete this list and all its tasks?');">
            Delete List
        </button>
    </form>

    <!-- Loop through tasks in the group, excluding those that are subtasks -->
    {% for task in group.tasks %}
    {% if not task.parent_task_id %}
    <div id="task-{{ task.id }}" draggable="true" ondragstart="drag(event, {{ task.id }})"
        style="border: 1px solid #888; padding: 5px; margin: 5px;">
        <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
        <span>{{ task.title }} ({{ task.status }})</span>

        <!-- Form to mark task as completed, using a checkmark button for simplicity -->
        <form action="{{ url_for('auth.delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" style="background: none; border: none; cursor: pointer;">
                ✔️
            </button>
        </form>

        <!-- Link to add a subtask, with depth limit check -->
        {% if task.get_depth() < 3 %} <a href="{{ url_for('auth.add_subtask', task_id=task.id) }}">Add Subtask</a>
            {% else %}
            <span style="color: gray;">Max depth reached</span>
            {% endif %}

            <!-- Render any subtasks using the macro defined above -->
            {% if task.subtasks %}
            <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<!-- JavaScript functions for collapsing subtasks, drag-and-drop functionality, and task movement -->
<script>
    // Toggle visibility of subtasks for a specific task
    function toggleSubtasks(taskId) {
        const subtasksDiv = document.getElementById(`subtasks-${taskId}`);
        const button = subtasksDiv.previousElementSibling.querySelector('.collapse-btn');
        if (subtasksDiv.style.display === "none") {
            subtasksDiv.style.display = "block";
            button.textContent = "▲";  // Change button to indicate collapse option
        } else {
            subtasksDiv.style.display = "none";
            button.textContent = "▼";  // Change button to indicate expand option
        }
    }

    // Allow drop event to happen in task group divs
    function allowDrop(event) {
        event.preventDefault();
    }

    // Start dragging a task, storing its ID in the event data transfer
    function drag(event, taskId) {
        event.dataTransfer.setData("taskId", taskId);
    }

    // Drop event to move a task to a new group
    function drop(event, newGroupId) {
        event.preventDefault();
        const taskId = event.dataTransfer.getData("taskId");

        // Send AJAX request to move the task to the new group
        fetch(`/move_task/${taskId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"  // CSRF token added here
            },
            body: JSON.stringify({ new_group_id: newGroupId })  // Specify the target group ID
        })
            .then(response => {
                if (response.ok) {
                    location.reload();  // Reload page to reflect changes
                } else {
                    response.json().then(data => {
                        alert(data.error || "Failed to move task.");  // Show error message if move fails
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred.");
            });
    }
</script>

{% endblock %}