{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h1>Your Task Dashboard</h1>

<div>
    <h2>Logged in as {{ current_user.username }} | <a href="{{ url_for('logout') }}">Logout</a></h2>
</div>

<div style="display: flex; gap: 20px;">
    <!-- To Do Column -->
    <div style="border: 1px solid #ccc; padding: 10px; width: 30%;">
        <h3>To Do</h3>
        {% for task in categorized_tasks['To Do'] %}
        <div>
            <p>{{ task.title }}</p>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
                <button type="submit">Delete</button>
            </form>
            <a href="{{ url_for('add_task', status='To Do', parent_task_id=task.id) }}">Add Subtask</a>

            <!-- Render subtasks recursively -->
            {% if task.subtasks %}
            <div style="margin-left: 20px;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        <a href="{{ url_for('add_task', status='To Do') }}">Add New Task</a>
    </div>

    <!-- In Progress Column -->
    <div style="border: 1px solid #ccc; padding: 10px; width: 30%;">
        <h3>In Progress</h3>
        {% for task in categorized_tasks['In Progress'] %}
        <div>
            <p>{{ task.title }}</p>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
                <button type="submit">Delete</button>
            </form>
            <a href="{{ url_for('add_task', status='In Progress', parent_task_id=task.id) }}">Add Subtask</a>

            <!-- Render subtasks recursively -->
            {% if task.subtasks %}
            <div style="margin-left: 20px;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        <a href="{{ url_for('add_task', status='In Progress') }}">Add New Task</a>
    </div>

    <!-- Done Column -->
    <div style="border: 1px solid #ccc; padding: 10px; width: 30%;">
        <h3>Done</h3>
        {% for task in categorized_tasks['Done'] %}
        <div>
            <p>{{ task.title }}</p>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
                <button type="submit">Delete</button>
            </form>
            <a href="{{ url_for('add_task', status='Done', parent_task_id=task.id) }}">Add Subtask</a>

            <!-- Render subtasks recursively -->
            {% if task.subtasks %}
            <div style="margin-left: 20px;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        <a href="{{ url_for('add_task', status='Done') }}">Add New Task</a>
    </div>
</div>

{% endblock %}

{% macro render_subtasks(task) %}
<div style="margin-left: 20px;">
    <p>{{ task.title }}</p>
    <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
        <button type="submit">Delete</button>
    </form>
    <a href="{{ url_for('add_task', status=task.status, parent_task_id=task.id) }}">Add Subtask</a>

    {% if task.subtasks %}
    <div style="margin-left: 20px;">
        {% for subtask in task.subtasks %}
        {{ render_subtasks(subtask) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}