{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% macro render_subtasks(task) %}
<div style="margin-left: 20px;">
    <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
    <span>{{ task.title }} ({{ task.status }})</span>
    <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Delete</button>
    </form>
    {% if task.get_depth < 3 %} <a href="{{ url_for('add_subtask', task_id=task.id) }}">Add Subtask</a>
        {% else %}
        <span style="color: gray;">Max depth reached</span>
        {% endif %}

        {% if task.subtasks %}
        <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
            {% for subtask in task.subtasks %}
            {{ render_subtasks(subtask) }}
            {% endfor %}
        </div>
        {% endif %}
</div>
{% endmacro %}

{% block content %}
<h1>Your Task Dashboard</h1>

<div>
    <h2>Logged in as {{ current_user.username }} | <a href="{{ url_for('logout') }}">Logout</a></h2>
</div>

<div>
    <h3><a href="{{ url_for('create_task_group') }}">Create New List</a></h3>
</div>

{% for group in task_groups %}
<div class="task-group" ondragover="allowDrop(event)" ondrop="drop(event, {{ group.id }})"
    style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
    <h2>{{ group.title }}</h2>
    <a href="{{ url_for('add_task', group_id=group.id) }}">Add New Task</a>

    {% for task in group.tasks %}
    {% if not task.parent_task_id %}
    <div id="task-{{ task.id }}" draggable="true" ondragstart="drag(event, {{ task.id }})"
        style="border: 1px solid #888; padding: 5px; margin: 5px;">
        <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
        <span>{{ task.title }} ({{ task.status }})</span>
        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" style="background: none; border: none; cursor: pointer;">
                ✔️
            </button>
        </form>
        {% if task.get_depth < 3 %} <a href="{{ url_for('add_subtask', task_id=task.id) }}">Add Subtask</a>
            {% else %}
            <span style="color: gray;">Max depth reached</span>
            {% endif %}

            {% if task.subtasks %}
            <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<script>
    function toggleSubtasks(taskId) {
        const subtasksDiv = document.getElementById(`subtasks-${taskId}`);
        const button = subtasksDiv.previousElementSibling.querySelector('.collapse-btn');
        if (subtasksDiv.style.display === "none") {
            subtasksDiv.style.display = "block";
            button.textContent = "▲";  // Change button to indicate collapse option
        } else {
            subtasksDiv.style.display = "none";
            button.textContent = "▼";  // Change button to indicate expand option
        }
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event, taskId) {
        event.dataTransfer.setData("taskId", taskId);
    }

    function drop(event, newGroupId) {
        event.preventDefault();
        const taskId = event.dataTransfer.getData("taskId");

        // Send AJAX request to move the task
        fetch(`/move_task/${taskId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"  // CSRF token added here
            },
            body: JSON.stringify({ new_group_id: newGroupId })
        })
            .then(response => {
                if (response.ok) {
                    location.reload();  // Reload page to reflect changes
                } else {
                    response.json().then(data => {
                        alert(data.error || "Failed to move task.");
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred.");
            });
    }
</script>
{% endblock %}