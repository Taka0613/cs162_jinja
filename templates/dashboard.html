<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% macro render_subtasks(task) %}
<div style="margin-left: 20px;">
    <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
    <span>{{ task.title }} ({{ task.status }})</span>
    <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
        <button type="submit">Delete</button>
    </form>
    {% if task.get_depth < 3 %} <a href="{{ url_for('add_subtask', task_id=task.id) }}">Add Subtask</a>
        {% else %}
        <span style="color: gray;">Max depth reached</span>
        {% endif %}

        {% if task.subtasks %}
        <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
            {% for subtask in task.subtasks %}
            {{ render_subtasks(subtask) }}
            {% endfor %}
        </div>
        {% endif %}
</div>
{% endmacro %}

{% block content %}
<h1>Your Task Dashboard</h1>

<div>
    <h2>Logged in as {{ current_user.username }} | <a href="{{ url_for('logout') }}">Logout</a></h2>
</div>

<div>
    <h3><a href="{{ url_for('create_task_group') }}">Create New List</a></h3>
</div>

{% for group in task_groups %}
<div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
    <h2>{{ group.title }}</h2>
    <a href="{{ url_for('add_task', group_id=group.id) }}">Add New Task</a>
    {% for task in group.tasks %}
    {% if not task.parent_task_id %}
    <div>
        <button class="collapse-btn" onclick="toggleSubtasks({{ task.id }})">▼</button>
        <span>{{ task.title }} ({{ task.status }})</span>
        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
            <button type="submit">Delete</button>
        </form>
        {% if task.get_depth < 3 %} <a href="{{ url_for('add_subtask', task_id=task.id) }}">Add Subtask</a>
            {% else %}
            <span style="color: gray;">Max depth reached</span>
            {% endif %}

            {% if task.subtasks %}
            <div class="subtasks" id="subtasks-{{ task.id }}" style="margin-left: 20px; display: none;">
                {% for subtask in task.subtasks %}
                {{ render_subtasks(subtask) }}
                {% endfor %}
            </div>
            {% endif %}
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<script>
    function toggleSubtasks(taskId) {
        const subtasksDiv = document.getElementById(`subtasks-${taskId}`);
        const button = subtasksDiv.previousElementSibling.querySelector('.collapse-btn');
        if (subtasksDiv.style.display === "none") {
            subtasksDiv.style.display = "block";
            button.textContent = "▲";  // Change button to indicate collapse option
        } else {
            subtasksDiv.style.display = "none";
            button.textContent = "▼";  // Change button to indicate expand option
        }
    }
</script>
{% endblock %}